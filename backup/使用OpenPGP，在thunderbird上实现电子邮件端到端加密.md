
> [!NOTE]
> 跨国收发电子邮件（尤其是经加密的电子邮件）丢信率极高。

> [!NOTE]
> 主题、发件人与收件人不会被加密，仍为明文。

> [!NOTE]
> 端到端加密技术本身无法避免Trust on First Use (TOFU，首次交换密钥时的信任危机) 问题，具体见下文。

## 基本情况

- Windows系统。
- 使用图形化界面（Kleopatra）。

## 生成与导出密钥

> [!NOTE]
> 建议专密专用，即一组密钥对仅对应一种用途（一个邮箱的加密）。

### 非对称加密原理

- 公钥与私钥相对应。

> [!CAUTION]
> 私钥不得告诉他人或公开！请警惕私钥泄露。

- 加密：公钥加密，私钥解密。
- 签名：私钥签名，公钥验证。

### 安装Gpg4win

- 下载链接：https://gpg4win.org/download.html

> 注意验证其SHA256或数字签名。

- 下载安装完成后，桌面会出现其图形化用户界面Kleopatra的快捷方式。后续操作基于Kleopatra。

### 创建OpenPGP密钥对

- 打开Kleopatra，点击“新建密钥对”。
- 填写名字与电子邮箱。填写的电子邮箱与欲使用端到端加密的电子邮箱保持一致。
- 强烈建议勾选“使用密码句保护生成的密钥”，否则任何访问该电脑的人均可查看存储其中的私钥。

> 如勾选，之后在密钥创建过程中会弹出设置密码的界面。

- 可在高级设置中设置密钥有效期限及加密方式。
- 点击确定，等待一段时间（视加密方式而定），完成密钥对创建。

### 导出公钥、私钥与吊销证书

> [!CAUTION]
> 该教程中导出的私钥文件应仅用于导入thunderbird！导入完毕后请立即删除。

> [!NOTE]
> 重置或更换电脑时，请将公钥与私钥导出并妥善备份。

- 导出公钥：右键点击创建的密钥对，点击“导出…”。
- 导出私钥：点击“备份私钥”。
- 创建吊销证书并妥善保存：双击创建的密钥对，点击“创建吊销证书”。

> 吊销证书用于当密钥对不再被使用或私钥被泄露时，声明该密钥对已失效。

> 密钥对被吊销后，先前加密/签名的文件仍可使用密钥对进行解密/验证，但密钥对持有者无法再用其签名任何新文件；持有公钥的第三方若已收到吊销证书，也无法再使用该公钥进行加密。

### （可选）直接在thunderbird上创建密钥

> [!NOTE]
> 完全可以只在thunderbird上创建密钥。但GnuPG不仅可以支持OpenPGP更进阶的用法，还更有利于对密钥对的完全掌控。

- 右键点击thunderbird上欲设置加密的邮箱，点击“设置”，进入账户设置。
- 点击“端到端加密”中的“添加密钥…”，在弹出的界面中选择“新建OpenPGP密钥”。
- “身份标识”项选择欲设置加密的邮箱。其他设置项同前，按需选择。
- 点击确定，等待一段时间，完成密钥对生成。

## 在thunderbird上导入私钥

- 右键点击thunderbird上欲设置加密的邮箱，点击“设置”，进入账户设置。
- 点击“端到端加密”中的“添加密钥…”，在弹出的界面中选择“导入现有的OpenPGP密钥”。
- 选择导入的文件，导入先前导出的私钥文件即可。

> 若先前设置过保护私钥的密码句，导入时会提示输入密码。

## 与他人交换公钥

### 发送公钥

- 发送公钥文件。
- 用记事本打开公钥文件，并将其内文字内容发送至对方。
- 上传公钥文件至密钥服务器，并发送密钥指纹或密钥服务器查询结果网址。

> 公用密钥服务器（可在此查询、上传公钥）：https://keys.openpgp.org/

> 该公钥服务器会使用创建密钥对时填写的邮箱，对密钥所有者身份进行验证。如需使用该密钥服务器，请务必在创建密钥对时填写欲使用加密的真实邮箱。

### 导入公钥

> Kleopatra：文件-导入，或工具-剪贴板-证书导入（复制公钥文本后）

> thunderbird：端到端加密-OpenPGP密钥管理器-文件-从文件导入公钥，或端到端加密-OpenPGP密钥管理器-编辑-从剪贴板/URL导入密钥（复制公钥文本/URL后）

- 接收并导入收到的公钥文件。
- 复制公钥文本并导入。
- 在密钥服务器上搜索。

### 公布公钥

- 公布密钥指纹。

> 用于在密钥服务器上查询对应公钥。

- 公布密钥服务器查询结果网址。

### 应对TOFU问题

- TOFU问题：首次交换公钥与邮箱账号时，我获取到的这个公钥/邮箱账号，是否真正属于“我想要联系的人”？
- 通过已与对方建立的其他可信渠道交换公钥（IM、短信、面对面交流……）

> 不建议通过“将要使用端到端加密的邮箱账号”交换公钥。

## 进行加密通信

### 加密文本后发送密文

- 将收件方的公钥导入Kleopatra。
- 选择“记事本”，在文本框中输入欲加密的文本。
- 点击“收件人”，设置签名身份（对应对方拥有的公钥）。
- 在“为他人加密”项选定接收方的公钥。

> 若未选择“为我加密”及“为他人加密”，即为只签名该文本。

> 仅选择“为我加密”，则该密文只能使用签名身份的私钥解密。

- 点击“签名/加密记事本内容”，复制生成的密文并发送。
- 接收方可在“解密/验证记事本内容”中解密密文，并验证该文本的数字签名是否属于发送方。

### 使用thunderbird端到端加密

- 将收件人的公钥导入thunderbird。

> thunderbird将自动基于公钥附带的电子邮箱账号信息匹配收件人。

- 点击“写信”，输入收件人与邮件内容，并点击“加密”，随后正常发送邮件。
- 发送的邮件将附带一个文件，此为该邮件的数字签名。收件人可通过公钥验证该电子邮件的来源。

> 数字签名的文件名形同：OpenPGP_0x00000000000.asc。

- 已导入私钥的电子邮箱账号，收到的由对应公钥加密的邮件将自动解密。

## （可选）使用提供端到端加密服务的邮件服务商

> [!NOTE]
> 所谓“端到端加密服务”通常仅限于使用该邮件服务的邮箱账号之间，且需要主动开启。不同服务商邮箱账号间的加密通信仍需单独配置。

> [!NOTE]
> 生成的私钥通常由服务商保存，用户可设置密码加密私钥。

- proton mail：https://account.proton.me/mail
- tuta mail：https://app.tuta.com/

## 参考

- https://emailselfdefense.fsf.org/zh-hans/
- https://zhuanlan.zhihu.com/p/570155198/
- https://blog.wangxuan.name/2021/10/03/protonmail-encryptied-email-review/